<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="favicon.svg" type="image/svg+xml">
  <title>Chord & Interval Trainer</title>
  <style>
 :root{
  --bg:#0f1724; 
  --card:#0b1220; 
  --muted:#9aa4b2; 
  --accent:#7dd3fc; 
  --good:#16a34a; 
  --bad:#ef4444; 
  --glass: rgba(255,255,255,0.03);
  --radius:14px; 
  --soft-shadow: 0 6px 18px rgba(2,6,23,0.6);
  font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
}

*{
  box-sizing:border-box
}

html,body{
  height:100%;
  margin:0;
  background:linear-gradient(180deg,#071427 0%, #08101a 100%);
  color:#e6eef6
}

.app{
  max-width:1100px;
  margin:28px auto;
  padding:20px;
}

header{
  display:flex;
  align-items:center;
  gap:16px;
  margin-bottom:18px;
  flex-wrap: wrap;
}

h1{
  font-size:20px;
  margin:0
}

.menu{
  display:flex;
  gap:8px;
  align-items:center;
  margin-left:auto
}

.menu button{
  background:transparent;
  border:1px solid var(--glass);
  padding:8px 12px;
  border-radius:10px;
  color:var(--muted);
  cursor:pointer
}

.menu button.active{
  background:linear-gradient(90deg,rgba(125,211,252,0.08),rgba(125,211,252,0.02));
  border-color:rgba(125,211,252,0.18);
  color:var(--accent)
}

main{
  display:grid;
  grid-template-columns:1fr;
  gap:18px
}

.card{
  background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  border-radius:var(--radius);
  padding:16px;
  box-shadow:var(--soft-shadow)
}

/* Chord generator */
.controls{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  align-items:center
}

select, .btn{
  padding:8px 12px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,0.04);
  background:transparent;
  color:inherit
}

.btn.primary{
  margin-top: 8px;
  border:none
}

.chord-list{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  margin-top:12px
}

option{
  font-family: "Verdana", "Helvetica", "Arial", sans-serif;
  color: #000;
}

.chord-item{
  min-width:120px;
  padding:10px;
  border-radius:10px;
  background:rgba(255,255,255,0.02);
  border:1px solid rgba(255,255,255,0.02);
}

input#chord-length{
  border-radius: 8px;
  color: var(--accent);
  background-color: #3f3f3f5c;
  font-weight: bold;
}

.chord-root{
  font-weight:700;
  font-size:18px
}

.chord-type{
  font-size:13px;
  color:var(--muted)
}

/* Piano */
.trainer-top{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  flex-wrap: wrap
}

.instruction{
  font-size:16px
}

.score{
  color:var(--muted)
}

.keyboard{
  width:100%;
  max-width:900px;
  margin:14px auto;
  position:relative;
  height:200px;
  user-select:none;
  display:flex
}


.octave{
  display:flex;
  position:relative;
  flex:1
}

.key{
  cursor:pointer;
  transition:all .08s ease;
  border:1px solid rgba(0,0,0,0.2)
}

.key:active{
  transform:translateY(2px)
}

.white{
  width:100%;
  height:100%;
  background:linear-gradient(to bottom, #fafafa 0%, #f0f0f0 100%);
  border-radius:0 0 4px 4px;
  box-shadow:0 4px 8px rgba(0,0,0,0.15);
  display:flex;
  align-items:flex-end;
  justify-content:center;
  padding-bottom:10px;
  font-size:13px;
  color:#444
}

.black{
  position:absolute;
  top:0;
  height:58%;
  width:58%;
  background:linear-gradient(to bottom, #1a1a1a 0%, #000 100%);
  border-radius:0 0 4px 4px;
  box-shadow:0 6px 12px rgba(0,0,0,0.7);
  z-index:10;
  display:flex;
  align-items:flex-end;
  justify-content:center;
  padding-bottom:6px;
  font-size:11px;
  color:#666
}

.black-1{
  left:64%
}

.black-2{
  left:78%
}

.black-4{
  left:60%
}

.black-5{
  left:72%
}

.black-6{
  left:84%
}

.key-label{
  font-size:12px;
  color:var(--muted)
}

.playing{
  box-shadow:0 8px 24px #dd9b20cc !important;
  background:rgb(221, 155, 32) !important;
  transform:translateY(2px) !important
}

.correct{
  background:linear-gradient(to bottom, rgb(96 255 0), rgb(22, 163, 74)) !important;
  box-shadow:0 6px 20px rgba(34, 197, 94, 0.6) !important
}

.wrong{
  background:linear-gradient(to bottom, rgb(255 108 0), rgb(220, 38, 38)) !important;
  box-shadow:0 6px 20px rgba(239, 68, 68, 0.6) !important
}

button#next-manual{
  background:linear-gradient(to bottom, rgb(96 255 0), rgb(22, 163, 74)) !important;
  box-shadow:0 6px 20px rgba(34, 197, 94, 0.6) !important
}

.chord-instruction {
    font-weight: bold;
    font-size: 16px;
    color: #dd9b20;
    text-shadow: #dd9b20cc 1px 0 10px;
}

.interval-options label { display:inline-block; margin-right:10px; }

/* --- Dropdown menu style --- */
.dropdown {
  position: relative;
  display: inline-block;
}

.dropdown-toggle {
  background-color: #2b2b2b00;
  color: var(--muted);
  border: none;
  padding: 8px 12px;
  font-size: 14px;
  border-radius: 6px;
  cursor: pointer;
}

.dropdown-toggle:hover {
  /* background-color: #071427; */
  background: linear-gradient(90deg, rgba(125, 211, 252, 0.08), rgba(125, 211, 252, 0.02));
  border-color: rgba(125, 211, 252, 0.18);
  color: var(--accent)
}

.dropdown-content {
  display: none;
  position: absolute;
  background-color: #071427;
  min-width: 220px;
  max-height: 300px;
  overflow-y: auto;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  border-radius: 8px;
  padding: 8px;
  z-index: 100;
}

.dropdown-content label {
  display: block;
  margin: 5px 0;
  cursor: pointer;
}

.dropdown.show .dropdown-content {
  display: block;
}

.controls-row{
  display:flex;
  gap:8px;
  align-items:center
}

.interval-box,
#select-all {
  accent-color: #dd9b20;
}

.interval-box2{
  accent-color: #dd9b20;
}

.chord-type-box,
#select-all-chords {
  accent-color: #dd9b20;
}

footer{
  margin-top:18px;
  color:var(--muted);
  font-size:13px;
  text-align:center
}

@keyframes rotate {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(-360deg);
  }
}

.rotate {
  animation: rotate 0.8s ease-in-out; /* vitesse r√©glable */
}


@media (min-width:900px){
  main{
    grid-template-columns:1fr 1fr
  }
}

@media (max-width:720px){
  .keyboard{
    height:120px
  }
}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Chord & Interval Trainer</h1>
      <div class="menu">
        <button id="menu-chords" class="active">üéµ G√©n√©rateur d'accords</button>
        <button id="menu-intervals">üéπ Entra√Ænement intervalles</button>
        <button id="menu-chord-trainer">üéπ Entra√Ænement accords</button>
      </div>
    </header>

    <main>
      <!-- Chord generator component -->
      <section id="chords" class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap: wrap">
          <div>
            <strong>G√©n√©rateur de partitions d'accords</strong>
          </div>
          <div style="display:flex;gap:8px;flex-wrap: wrap;align-items:center">
            <select id="chord-category">
              <!-- categories injected by JS -->
            </select>
            <input id="chord-length" type="number" min="1" max="12" value="10" style="width:30px" title="Nombre d'accords" />
            <button class="btn primary" id="new-partition">
              <svg xmlns="http://www.w3.org/2000/svg" width="45" height="45" viewBox="0 0 95 80" fill="none">
                <g filter="url(#filter0_d_2977_58)">
                <mask id="path-1-inside-1_2977_58" fill="white">
                <path d="M72.998 38.2368C72.998 32.649 71.1627 27.2159 67.7741 22.7729C64.3855 18.3298 59.6313 15.1228 54.2425 13.6449C48.8537 12.167 43.1287 12.5 37.9476 14.5928C32.7665 16.6856 28.4163 20.4222 25.5657 25.2282L34.6623 30.6236C36.3306 27.8109 38.8765 25.6241 41.9087 24.3993C44.9409 23.1745 48.2915 22.9796 51.4452 23.8445C54.599 24.7095 57.3813 26.5864 59.3645 29.1866C61.3476 31.7869 62.4218 34.9666 62.4218 38.2368H72.998Z"/>
                </mask>
                <path d="M72.998 38.2368C72.998 32.649 71.1627 27.2159 67.7741 22.7729C64.3855 18.3298 59.6313 15.1228 54.2425 13.6449C48.8537 12.167 43.1287 12.5 37.9476 14.5928C32.7665 16.6856 28.4163 20.4222 25.5657 25.2282L34.6623 30.6236C36.3306 27.8109 38.8765 25.6241 41.9087 24.3993C44.9409 23.1745 48.2915 22.9796 51.4452 23.8445C54.599 24.7095 57.3813 26.5864 59.3645 29.1866C61.3476 31.7869 62.4218 34.9666 62.4218 38.2368H72.998Z" fill="#7DD3FC" stroke="#00B3FF" stroke-width="2" mask="url(#path-1-inside-1_2977_58)"/>
                <mask id="path-2-inside-2_2977_58" fill="white">
                <path d="M22.0059 41.7383C22.0059 47.3261 23.8413 52.7591 27.2298 57.2022C30.6184 61.6453 35.3726 64.8523 40.7614 66.3302C46.1502 67.8081 51.8752 67.4751 57.0563 65.3823C62.2374 63.2895 66.5876 59.5529 69.4382 54.7469L60.3416 49.3515C58.6733 52.1642 56.1274 54.351 53.0952 55.5758C50.063 56.8006 46.7125 56.9955 43.5587 56.1305C40.4049 55.2656 37.6226 53.3887 35.6394 50.7884C33.6563 48.1882 32.5821 45.0085 32.5821 41.7383L22.0059 41.7383Z"/>
                </mask>
                <path d="M22.0059 41.7383C22.0059 47.3261 23.8413 52.7591 27.2298 57.2022C30.6184 61.6453 35.3726 64.8523 40.7614 66.3302C46.1502 67.8081 51.8752 67.4751 57.0563 65.3823C62.2374 63.2895 66.5876 59.5529 69.4382 54.7469L60.3416 49.3515C58.6733 52.1642 56.1274 54.351 53.0952 55.5758C50.063 56.8006 46.7125 56.9955 43.5587 56.1305C40.4049 55.2656 37.6226 53.3887 35.6394 50.7884C33.6563 48.1882 32.5821 45.0085 32.5821 41.7383L22.0059 41.7383Z" fill="#7DD3FC" stroke="#00B3FF" stroke-width="2" mask="url(#path-2-inside-2_2977_58)"/>
                <path d="M20.8317 37.8516C19.4459 37.8608 18.3172 36.7406 18.3154 35.3547L18.2911 14.7554C18.2886 12.5315 20.9737 11.4111 22.5524 12.9772L43.1749 33.4398C44.7536 35.0063 43.6539 37.7001 41.43 37.7148L20.8317 37.8516Z" fill="#7DD3FC" stroke="#00B3FF"/>
                <path d="M73.6842 41.9352C75.0701 41.929 76.1964 43.0515 76.1953 44.4374L76.1757 65.0368C76.1736 67.2606 73.486 68.3754 71.9107 66.8059L51.3317 46.2995C49.7564 44.7297 50.8618 42.0382 53.0857 42.0282L73.6842 41.9352Z" fill="#7DD3FC" stroke="#00B3FF"/>
                <rect x="29.3281" y="21.7993" width="2.07925" height="8.59769" transform="rotate(-44.5531 29.3281 21.7993)" fill="#7DD3FC"/>
                <rect x="57.7383" y="53.9766" width="2.07925" height="8.57069" transform="rotate(-42.3691 57.7383 53.9766)" fill="#7DD3FC"/>
                </g>
                <defs>
                <filter id="filter0_d_2977_58" x="13.691" y="7.64609" width="69.1043" height="66.4944" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
                <feFlood flood-opacity="0" result="BackgroundImageFix"/>
                <feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/>
                <feOffset dx="1" dy="1"/>
                <feGaussianBlur stdDeviation="2.55"/>
                <feComposite in2="hardAlpha" operator="out"/>
                <feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0.698039 0 0 0 0 1 0 0 0 1 0"/>
                <feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow_2977_58"/>
                <feBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow_2977_58" result="shape"/>
                </filter>
                </defs>
              </svg>
            </button>          
          </div>
        </div>

        <div class="chord-list" id="chord-list" aria-live="polite" style="margin-top:14px"></div>
      </section>

      <!-- Interval trainer component -->
      <section id="intervals" class="card" style="display:none">
        <div class="trainer-top">
          <div>
            <div class="instruction" id="instruction">Trouve l'intervalle : <span class="chord-instruction" id="chord-instruction">Note</span></div>
            <div class="score" id="score">Bonnes r√©ponses : 0 / Essais : 0</div>
          </div>
          <div class="controls-row">
            <div class="dropdown">
              <button class="dropdown-toggle" id="dropdown-toggle">üéµ Choisir les intervalles ‚ñæ</button>
              <div id="interval-menu" class="dropdown-content">
                <label><input type="checkbox" id="select-all" checked> Tout s√©lectionner</label>
                <label><input type="checkbox" class="interval-box" value="0" checked> Unisson</label>
                <label><input type="checkbox" class="interval-box" value="1" checked> Half step</label>
                <label><input type="checkbox" class="interval-box" value="2" checked> Whole step</label>
                <label><input type="checkbox" class="interval-box" value="3" checked> Min 3rd</label>
                <label><input type="checkbox" class="interval-box" value="4" checked> Maj 3rd</label>
                <label><input type="checkbox" class="interval-box" value="5" checked> 4th</label>
                <label><input type="checkbox" class="interval-box" value="6" checked> Tritone</label>
                <label><input type="checkbox" class="interval-box" value="7" checked> 5th</label>
                <label><input type="checkbox" class="interval-box" value="8" checked> Min 6th</label>
                <label><input type="checkbox" class="interval-box" value="9" checked> Maj 6th</label>
                <label><input type="checkbox" class="interval-box" value="10" checked> Min 7th</label>
                <label><input type="checkbox" class="interval-box" value="11" checked> Maj 7th</label>
                <label><input type="checkbox" class="interval-box" value="12" checked> Octave</label>
            </div>
          </div>
                        
            <div style="display:flex;gap:8px;align-items:center">
              <button class="btn" id="next-manual" style="display:none">Suivant</button>
            </div>
          </div>
        </div>
        
        <div class="keyboard" id="keyboard"></div>
      </section>

      <!-- Chord trainer (nouvelle section) -->
      <section id="chord-trainer" class="card" style="display:none">
        <div class="trainer-top">
          <div>
            <div class="instruction" id="instruction2">Trouve l'intervalle : <span class="chord-instruction" id="chord-instruction2">Note</span></div>
          </div>
          <div class="controls-row">
            <div class="dropdown">
              <button class="dropdown-toggle" id="dropdown-toggle2">üéµ Choisir les accords ‚ñæ</button>
              <div id="chord-type-menu" class="dropdown-content">
                <label><input type="checkbox" id="select-all-chords" checked> Tout s√©lectionner</label>
                <label><input type="checkbox" class="chord-type-box" value="maj" checked> Majeur (maj)</label>
                <label><input type="checkbox" class="chord-type-box" value="min" checked> Mineur (min)</label>
                <label><input type="checkbox" class="chord-type-box" value="dim" checked> Diminu√© (dim)</label>
                <label><input type="checkbox" class="chord-type-box" value="aug" checked> Augment√© (aug)</label>
                <label><input type="checkbox" class="chord-type-box" value="sus2" checked> Sus2</label>
                <label><input type="checkbox" class="chord-type-box" value="sus4" checked> Sus4</label>
                <label><input type="checkbox" class="chord-type-box" value="7" checked> Dominant 7e (7)</label>
                <label><input type="checkbox" class="chord-type-box" value="maj7" checked> 7e majeure (maj7)</label>
                <label><input type="checkbox" class="chord-type-box" value="m7" checked> 7e mineure (m7)</label>
                <label><input type="checkbox" class="chord-type-box" value="m7b5" checked> Mi 7e b5 (m7b5)</label>
                <label><input type="checkbox" class="chord-type-box" value="dim7" checked> Diminu√© 7e (dim7)</label>
                <label><input type="checkbox" class="chord-type-box" value="7sus4" checked> 7 sus4</label>
                <label><input type="checkbox" class="chord-type-box" value="7b9" checked> 7 b9</label>
                <label><input type="checkbox" class="chord-type-box" value="maj7#11" checked> Maj7 #11</label>
              </div>
          </div>
                        
            <div style="display:flex;gap:8px;align-items:center">
              <button class="btn" id="chord-next">Suivant</button>
            </div>
          </div>
        </div>
        <div class="keyboard" id="chord-trainer-container"></div>
      </section>
    </main>
  </div>

  <script>
/* ---------- Music helpers ---------- */
const NOTES_SHARP = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
const NOTES_FLAT  = ['C','D‚ô≠','D','E‚ô≠','E','F','G‚ô≠','G','A‚ô≠','A','B‚ô≠','B'];

function midiToNote(m){
  const octave = Math.floor(m/12) - 1;
  const nameSharp = NOTES_SHARP[m%12];
  const nameFlat = NOTES_FLAT[m%12];
  return {midi:m, nameSharp, nameFlat, octave, label: `${nameSharp}${octave}`};
}

function noteToMidi(name){
  const m = name.match(/^([A-Ga-g])([#b]?)(\d+)$/);
  if(!m) return null;
  const pitch = m[1].toUpperCase(); const acc = m[2]||''; const oct = parseInt(m[3],10);
  let idx = ['C','D','E','F','G','A','B'].indexOf(pitch);
  const base = {C:0,D:2,E:4,F:5,G:7,A:9,B:11}[pitch];
  let semis = base + (acc==='#'?1:acc==='‚ô≠'?-1:0);
  return (oct+1)*12 + ((semis%12)+12)%12;
}

/* ---------- Chord data ---------- */
const CHORD_TYPES = {
  'Triade majeure':{abbr:'maj', intervals:[0,4,7]},
  'Triade mineure':{abbr:'min', intervals:[0,3,7]},
  '7e majeure':{abbr:'maj7', intervals:[0,4,7,11]},
  '7e mineure':{abbr:'m7', intervals:[0,3,7,10]},
  '6e':{abbr:'6', intervals:[0,4,7,9]},
  'sus2':{abbr:'sus2', intervals:[0,2,7]},
  'sus4':{abbr:'sus4', intervals:[0,5,7]},
  'aug':{abbr:'aug', intervals:[0,4,8]},
  'dim':{abbr:'dim', intervals:[0,3,6]},
  'dominant 7e':{abbr:'7', intervals:[0,4,7,10]}
};

const CATEGORIES = {
  'Triades majeures': ['Triade majeure'],
  'Triades mineures': ['Triade mineure'],
  'Accords de 7e majeurs': ['7e majeure'],
  'Accords de 7e mineurs': ['7e mineure'],
  'Mix triades majeures et mineures': ['Triade majeure','Triade mineure'],
  'Mix accords de 7e': ['7e majeure','7e mineure'],
  'Mix 7e et dominant': ['7e majeure','7e mineure','dominant 7e'],
  'Mix aug et dim': ['aug','dim'],
  'Mix de tout': Object.keys(CHORD_TYPES)
};

const ROOTS = (()=>{
  const roots = [];
  for(let i=0;i<12;i++) roots.push(NOTES_SHARP[i]);
  return roots;
})();

/* ---------- UI: Chord generator ---------- */
class ChordGenerator{
  constructor(listEl){
    this.listEl = listEl;
    this.populateCategories();
  }
  populateCategories(){
    const sel = document.getElementById('chord-category');
    sel.innerHTML = '';
    for(const k of Object.keys(CATEGORIES)){
      const opt = document.createElement('option'); opt.value = k; opt.textContent = k; sel.appendChild(opt);
    }
  }
  generate(category, length){
    const types = CATEGORIES[category] || [category];
    const chords = [];
    for(let i=0;i<length;i++){
      const root = ROOTS[Math.floor(Math.random()*ROOTS.length)];
      const typeName = types[Math.floor(Math.random()*types.length)];
      const type = CHORD_TYPES[typeName];
      const displayRoot = this.formatRoot(root);
      chords.push({root, displayRoot, typeName, abbr:type ? type.abbr : '', intervals:type?type.intervals:[]});
    }
    this.render(chords);
  }

//   generate(category, length) {
//   const types = CATEGORIES[category] || [category];
//   const chords = [];

//   // On cr√©e une copie m√©lang√©e de ROOTS
//   const availableRoots = [...ROOTS];
//   for (let i = availableRoots.length - 1; i > 0; i--) {
//     const j = Math.floor(Math.random() * (i + 1));
//     [availableRoots[i], availableRoots[j]] = [availableRoots[j], availableRoots[i]];
//   }

//   for (let i = 0; i < length; i++) {
//     // On choisit un root al√©atoire dans la liste m√©lang√©e
//     const root = availableRoots[i % availableRoots.length];
//     const typeName = types[Math.floor(Math.random() * types.length)];
//     const type = CHORD_TYPES[typeName];

//     const displayRoot = this.formatRoot(root);
//     chords.push({
//       root,
//       displayRoot,
//       typeName,
//       abbr: type ? type.abbr : '',
//       intervals: type ? type.intervals : []
//     });
//   }

//   // On m√©lange aussi la liste finale
//   chords.sort(() => Math.random() - 0.5);

//   this.render(chords);
// }


//   generate(category, length){
//   const types = CATEGORIES[category] || [category];

//   // On copie et m√©lange les notes de base
//   const shuffledRoots = [...ROOTS]
//     .sort(() => Math.random() - 0.5); // m√©lange al√©atoire

//   const chords = [];
//   for(let i=0;i<length;i++){
//     const root = shuffledRoots[i % shuffledRoots.length]; // √©vite de d√©passer si length > 12
//     const typeName = types[Math.floor(Math.random()*types.length)];
//     const type = CHORD_TYPES[typeName];
//     const displayRoot = this.formatRoot(root);
//     chords.push({root, displayRoot, typeName, abbr:type ? type.abbr : '', intervals:type?type.intervals:[]});
//   }

//   // M√©lange aussi la liste finale pour un ordre vraiment al√©atoire
//   const randomized = chords.sort(() => Math.random() - 0.5);
//   this.render(randomized);
// }

  formatRoot(root){
    const idx = NOTES_SHARP.indexOf(root);
    if(idx===-1) return root;
    const flat = NOTES_FLAT[idx];
    if(root.includes('#')) return `${flat}`;
    return root;
  }
  render(chords){
    this.listEl.innerHTML='';
    for(const c of chords){
      const node = document.createElement('div'); node.className='chord-item';
      node.innerHTML = `<div class="chord-root">${c.displayRoot} ${c.abbr? c.abbr : ''}</div>`;
      this.listEl.appendChild(node);
    }
  }
}

/* ---------- Interval trainer ---------- */
class IntervalTrainer{
  constructor(keyboardEl){
    this.el = keyboardEl;
    this.minMidi = noteToMidi('C3');
    this.maxMidi = noteToMidi('C5');
    this.octaves = [];
    this.onAnswer = null;
    this.buildKeyboard();
    this.correct=0; this.attempts=0;
    this.current = null;
    this.awaitingAcknowledgement = false;
    this.allowedIntervals = [...Array(13).keys()];
  }
  
  buildKeyboard(){
    this.noteEls = {};

    const octaves = [
      {start: 48, label: '3'},
      {start: 60, label: '4'}
    ];
    
    octaves.forEach(octave => {
      const octaveDiv = document.createElement('div');
      octaveDiv.className = 'octave';
      
      const whiteKeys = [
        {midi: octave.start, name: 'C', hasBlack: true, blackPos: 'black-1'},
        {midi: octave.start + 2, name: 'D', hasBlack: true, blackPos: 'black-2'},
        {midi: octave.start + 4, name: 'E', hasBlack: false},
        {midi: octave.start + 5, name: 'F', hasBlack: true, blackPos: 'black-4'},
        {midi: octave.start + 7, name: 'G', hasBlack: true, blackPos: 'black-5'},
        {midi: octave.start + 9, name: 'A', hasBlack: true, blackPos: 'black-6'},
        {midi: octave.start + 11, name: 'B', hasBlack: false}
      ];
      
      whiteKeys.forEach(wKey => {
        const whiteDiv = document.createElement('div');
        whiteDiv.style.position = 'relative';
        whiteDiv.style.flex = '1';
        whiteDiv.style.height = '100%';
        
        const white = document.createElement('div');
        white.className = 'key white';
        white.dataset.midi = wKey.midi;
        white.dataset.note = `${wKey.name}${octave.label}`;
        whiteDiv.appendChild(white);
        this.noteEls[wKey.midi] = white;
        
        if (wKey.hasBlack) {
          const blackMidi = wKey.midi + 1;
          const black = document.createElement('div');
          black.className = `key black ${wKey.blackPos}`;
          black.dataset.midi = blackMidi;
          const blackName = midiToNote(blackMidi).nameFlat;
          black.dataset.note = `${blackName}${octave.label}`;
          whiteDiv.appendChild(black);
          this.noteEls[blackMidi] = black;
        }
        
        octaveDiv.appendChild(whiteDiv);
      });
      
      this.el.appendChild(octaveDiv);
    });
    
    const lastOctaveDiv = this.el.querySelectorAll('.octave')[this.el.querySelectorAll('.octave').length - 1];
    const c5Div = document.createElement('div');
    c5Div.style.position = 'relative';
    c5Div.style.flex = '1';
    c5Div.style.height = '100%';

    const c5 = document.createElement('div');
    c5.className = 'key white';
    c5.dataset.midi = 72;
    c5.dataset.note = 'C5';
    c5Div.appendChild(c5);
    this.noteEls[72] = c5;
    lastOctaveDiv.appendChild(c5Div);
    
    this.el.querySelectorAll('.key').forEach(k => {
      k.addEventListener('click', (e) => {
        e.stopPropagation();
        this.onKeyClick(parseInt(k.dataset.midi));
      });
    });
  }

  randomInterval(){
    const allowed = this.allowedIntervals;
    return allowed[Math.floor(Math.random() * allowed.length)];
  }
  
  intervalName(i){
    const names = {0:'unisson',1:'half step',2:'whole step',3:'min 3rd',4:'maj 3rd',5:'4th',6:'tritone',7:'5th',8:'min 6th',9:'maj 6th',10:'min 7th',11:'maj 7th',12:'octave'};
    return names[i] || i+" semitones";
  }
  
  startNew(difficulty='normal'){
    if(this.awaitingAcknowledgement) return;
    const interval = this.randomInterval();
    const minStart = this.minMidi;
    const maxStart = this.maxMidi - interval;
    const start = Math.floor(Math.random()*(maxStart-minStart+1)) + minStart;
    this.current = {start, interval, answerMidi:start+interval};
    this.updateInstruction();
    this.clearHighlights();
    const startEl = this.noteEls[this.current.start]; if(startEl) this.markPlaying(startEl);
  }
  
  updateInstruction(){
    const instr = document.getElementById('chord-instruction');
    const startMidi = this.current.start;
    const startNote = midiToNote(startMidi).nameSharp;
    instr.textContent = `${startNote} ${this.intervalName(this.current.interval)}`;
  }
  
  markPlaying(el){
    this.clearHighlights(); el.classList.add('playing');
  }
  
  clearHighlights(){
    Object.values(this.noteEls).forEach(k=>{k.classList.remove('playing','correct','wrong')});
  }
  
  onKeyClick(midi) {
    if (!this.current) return;
    const el = this.noteEls[midi];
    
    if(this.awaitingAcknowledgement) return;
    
    if(midi === this.current.answerMidi){
      el.classList.add('correct');
      this.correct++; this.attempts++;
      this.updateScore();
      setTimeout(()=>{ this.startNew(); }, 900);
    } else {
      el.classList.add('wrong');
      const correctEl = this.noteEls[this.current.answerMidi]; 
      if(correctEl) correctEl.classList.add('correct');
      this.attempts++; this.updateScore();
      this.awaitingAcknowledgement = true;
      document.getElementById('next-manual').style.display='inline-block';
    }
  }
  
  updateScore(){
    document.getElementById('score').textContent = `Bonnes r√©ponses : ${this.correct} / Essais : ${this.attempts}`;
  }
  
  acknowledge(){
    this.awaitingAcknowledgement=false;
    document.getElementById('next-manual').style.display='none';
    this.clearHighlights();
    this.startNew();
  }
}

/* ---------- Chord Trainer Section ---------- */
class ChordTrainerSection {
    constructor(containerId, nextBtnId) {
        this.container = document.getElementById(containerId);
        this.nextBtn = document.getElementById(nextBtnId);
        this.noteEls = {};
        this.currentChord = null;
        this.selectedNotes = [];
        this.onNext = null;

        this.buildKeyboard();
        this.nextBtn.addEventListener('click', () => this.nextChord());
    }

    buildKeyboard() {
        this.noteEls = {};

        const octaves = [
            { start: 48, label: '3' },
            { start: 60, label: '4' }
        ];

        octaves.forEach(octave => {
            const octaveDiv = document.createElement('div');
            octaveDiv.className = 'octave';

            const whiteKeys = [
                { midi: octave.start, name: 'C', hasBlack: true, blackPos: 'black-1' },
                { midi: octave.start + 2, name: 'D', hasBlack: true, blackPos: 'black-2' },
                { midi: octave.start + 4, name: 'E', hasBlack: false },
                { midi: octave.start + 5, name: 'F', hasBlack: true, blackPos: 'black-4' },
                { midi: octave.start + 7, name: 'G', hasBlack: true, blackPos: 'black-5' },
                { midi: octave.start + 9, name: 'A', hasBlack: true, blackPos: 'black-6' },
                { midi: octave.start + 11, name: 'B', hasBlack: false }
            ];

            whiteKeys.forEach(wKey => {
                const whiteDiv = document.createElement('div');
                whiteDiv.style.position = 'relative';
                whiteDiv.style.flex = '1';
                whiteDiv.style.height = '100%';

                const white = document.createElement('div');
                white.className = 'key white';
                white.dataset.midi = wKey.midi;
                white.dataset.note = `${wKey.name}${octave.label}`;
                whiteDiv.appendChild(white);
                this.noteEls[wKey.midi] = white;

                if (wKey.hasBlack) {
                    const blackMidi = wKey.midi + 1;
                    const black = document.createElement('div');
                    black.className = `key black ${wKey.blackPos}`;
                    black.dataset.midi = blackMidi;
                    black.dataset.note = `${this.midiToNoteName(blackMidi)}${octave.label}`;
                    whiteDiv.appendChild(black);
                    this.noteEls[blackMidi] = black;
                }

                octaveDiv.appendChild(whiteDiv);
            });

            this.container.appendChild(octaveDiv);
        });

        const c5Div = document.createElement('div');
        c5Div.style.position = 'relative';
        c5Div.style.flex = '1';
        c5Div.style.height = '100%';

        const c5 = document.createElement('div');
        c5.className = 'key white';
        c5.dataset.midi = 72;
        c5.dataset.note = 'C5';
        c5Div.appendChild(c5);
        this.noteEls[72] = c5;
        this.container.lastElementChild.appendChild(c5Div);

        this.container.querySelectorAll('.key').forEach(k => {
            k.addEventListener('click', (e) => {
                e.stopPropagation();
                this.onKeyClick(parseInt(k.dataset.midi));
            });
        });
    }

    midiToNoteName(midi) {
        const NOTES_SHARP = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
        return NOTES_SHARP[midi % 12];
    }

    startChord(chord) {
        this.currentChord = chord;
        this.selectedNotes = [];
        this.nextBtn.style.display = 'none';
        this.clearHighlights();

        const instr = document.getElementById('chord-instruction2');
        instr.textContent = `${chord.root} ${chord.typeName}`;
    }

    onKeyClick(midi) {
        if (!this.currentChord) return;

        const el = this.noteEls[midi];
        const noteClicked = el.dataset.note.replace(/\d+/, '');

        if (this.selectedNotes.includes(noteClicked)) return;

        const equivalents = this.normalizeNote(noteClicked);
        const isCorrect = equivalents.some(n => this.currentChord.correctNotes.includes(n));

        if (isCorrect) {
            el.classList.add('correct');
            this.selectedNotes.push(noteClicked);

            const allSelected = this.currentChord.correctNotes.every(n =>
                this.selectedNotes.includes(n) || this.normalizeNote(n).some(e => this.selectedNotes.includes(e))
            );

            if (allSelected) setTimeout(() => this.nextChord(), 500);

        } else {
            el.classList.add('wrong');
            this.showCorrectNotes();
            this.nextBtn.style.display = 'inline-block';
        }
    }

    normalizeNote(note) {
        const map = {
            'C#': 'Db', 'Db': 'C#',
            'D#': 'Eb', 'Eb': 'D#',
            'F#': 'Gb', 'Gb': 'F#',
            'G#': 'Ab', 'Ab': 'G#',
            'A#': 'Bb', 'Bb': 'A#'
        };
        return map[note] ? [note, map[note]] : [note];
    }

    showCorrectNotes() {
        Object.values(this.noteEls).forEach(k => {
            const baseNote = k.dataset.note.replace(/\d+/, '');
            if (this.currentChord.correctNotes.some(n => this.normalizeNote(n).includes(baseNote))) {
                k.classList.add('correct');
            }
        });
    }

    clearHighlights() {
        Object.values(this.noteEls).forEach(k => k.classList.remove('correct', 'wrong'));
    }

    nextChord() {
        this.selectedNotes = [];
        this.nextBtn.style.display = 'none';
        this.clearHighlights();
        if (typeof this.onNext === 'function') this.onNext();
    }
}

/* ---------- App wiring ---------- */
document.addEventListener('DOMContentLoaded', ()=>{

  /* ---------- Chord Generator ---------- */
  const chordGen = new ChordGenerator(document.getElementById('chord-list'));
  const defaultCat = Object.keys(CATEGORIES)[0];
  document.getElementById('chord-category').value = defaultCat;
  chordGen.generate(defaultCat, parseInt(document.getElementById('chord-length').value,10));

  document.getElementById('new-partition').addEventListener('click', ()=>{
    const cat = document.getElementById('chord-category').value;
    const len = parseInt(document.getElementById('chord-length').value||4,10);
    chordGen.generate(cat, len);
  });

  /* ---------- Interval Trainer ---------- */
  const intervalTrainer = new IntervalTrainer(document.getElementById('keyboard'));

  function setupDropdown(toggleId, menuId) {
    const toggleBtn = document.getElementById(toggleId);
    const menuElement = document.getElementById(menuId);
    
    if (!toggleBtn || !menuElement) {
      console.warn(`Dropdown elements not found: ${toggleId} or ${menuId}`);
      return;
    }
    
    const menu = menuElement.parentElement;

    toggleBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));
      menu.classList.toggle('show');
    });

    window.addEventListener('click', (e) => {
        // ‚úÖ Si on clique √† l'int√©rieur du menu (checkbox, label, etc.), ne rien faire
        if (menu.contains(e.target) && !e.target.matches('button')) return;

        // üî¥ Sinon (clic ailleurs ou sur le bouton), on ferme le menu
        menu.classList.remove('show');
    });
  }

  setupDropdown('dropdown-toggle', 'interval-menu');

  document.getElementById('interval-menu').addEventListener('click', (e) => {
  e.stopPropagation();
});

  const checkboxes = document.querySelectorAll('.interval-box');
  const selectAllBox = document.getElementById('select-all');

  function updateAllowedIntervals() {
    const selected = Array.from(checkboxes)
      .filter(cb => cb.checked)
      .map(cb => parseInt(cb.value, 10));
    intervalTrainer.allowedIntervals = selected.length ? selected : [];
    intervalTrainer.startNew();
  }

  selectAllBox.addEventListener('change', () => {
    checkboxes.forEach(cb => cb.checked = selectAllBox.checked);
    updateAllowedIntervals();
  });

  checkboxes.forEach(cb => {
    cb.addEventListener('change', () => {
      if (!cb.checked) selectAllBox.checked = false;
      if (Array.from(checkboxes).every(c => c.checked)) selectAllBox.checked = true;
      updateAllowedIntervals();
    });
  });

  updateAllowedIntervals();
  intervalTrainer.startNew();
  document.getElementById('next-manual').addEventListener('click', ()=>{ intervalTrainer.acknowledge(); });

  /* ---------- Chord Trainer Section ---------- */
  const chordTrainer = new ChordTrainerSection('chord-trainer-container','chord-next');

  // D√©finition de tous les accords
  const chordList = [];

  const chordTypes = {
    maj: [0, 4, 7],
    min: [0, 3, 7],
    dim: [0, 3, 6],
    aug: [0, 4, 8],
    sus2: [0, 2, 7],
    sus4: [0, 5, 7],
    '7': [0, 4, 7, 10],
    maj7: [0, 4, 7, 11],
    m7: [0, 3, 7, 10],
    m7b5: [0, 3, 6, 10],
    dim7: [0, 3, 6, 9],
    '7sus4': [0, 5, 7, 10],
    '7b9': [0, 4, 7, 10, 13],
    'maj7#11': [0, 4, 7, 11, 18],
  };

  const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];

  for (const root of notes) {
    const rootIndex = notes.indexOf(root);
    for (const [typeName, intervals] of Object.entries(chordTypes)) {
      const correctNotes = intervals.map(semi => notes[(rootIndex + semi) % 12]);
      chordList.push({ root, typeName, correctNotes });
    }
  }

  // Setup du dropdown pour le chord trainer
  setupDropdown('dropdown-toggle2', 'chord-type-menu');

  // Gestion de "Tout s√©lectionner" pour les types d'accords
  const chordTypeBoxes = document.querySelectorAll('.chord-type-box');
  const selectAllChords = document.getElementById('select-all-chords');

  selectAllChords.addEventListener('change', () => {
    chordTypeBoxes.forEach(cb => cb.checked = selectAllChords.checked);
    updateAllowedChordTypes();
  });

  chordTypeBoxes.forEach(cb => {
    cb.addEventListener('change', () => {
      if (!cb.checked) selectAllChords.checked = false;
      if (Array.from(chordTypeBoxes).every(c => c.checked)) selectAllChords.checked = true;
      updateAllowedChordTypes();
    });
  });

  // Fonction pour mettre √† jour les accords disponibles
  let filteredChordList = [...chordList];
  let currentIndex = 0;

  function updateAllowedChordTypes() {
    const selectedTypes = Array.from(chordTypeBoxes)
      .filter(cb => cb.checked)
      .map(cb => cb.value);
    
    if (selectedTypes.length === 0) {
      filteredChordList = [];
      return;
    }
    
    filteredChordList = shuffleArray(chordList.filter(chord => selectedTypes.includes(chord.typeName)));

    if (filteredChordList.length > 0) {
      currentIndex = 0;
      chordTrainer.startChord(filteredChordList[currentIndex]);
    }
  }

  function shuffleArray(array) {
  const shuffled = [...array]; // on copie pour ne pas modifier l'original
  for (let i = shuffled.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1)); // indice al√©atoire entre 0 et i
    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]]; // √©change des √©l√©ments
  }
  return shuffled;
}

  // Modifier le callback onNext pour utiliser la liste filtr√©e
  chordTrainer.onNext = () => {
    if (filteredChordList.length === 0) return;
    currentIndex = (currentIndex + 1) % filteredChordList.length;
    chordTrainer.startChord(filteredChordList[currentIndex]);
  };

  // Initialiser
  updateAllowedChordTypes();

  /* ---------- Menu navigation ---------- */
  const secChords = document.getElementById('chords');
  const secIntervals = document.getElementById('intervals');
  const secChordTrainer = document.getElementById('chord-trainer');

  document.getElementById('menu-chords').addEventListener('click', ()=>{
    secChords.style.display='block';
    secIntervals.style.display='none';
    secChordTrainer.style.display='none';
    document.getElementById('menu-chords').classList.add('active');
    document.getElementById('menu-intervals').classList.remove('active');
    document.getElementById('menu-chord-trainer').classList.remove('active');
  });

  document.getElementById('menu-intervals').addEventListener('click', ()=>{
    secChords.style.display='none';
    secIntervals.style.display='block';
    secChordTrainer.style.display='none';
    document.getElementById('menu-chords').classList.remove('active');
    document.getElementById('menu-intervals').classList.add('active');
    document.getElementById('menu-chord-trainer').classList.remove('active');
  });

  document.getElementById('menu-chord-trainer').addEventListener('click', ()=>{
    secChords.style.display='none';
    secIntervals.style.display='none';
    secChordTrainer.style.display='block';
    document.getElementById('menu-chords').classList.remove('active');
    document.getElementById('menu-intervals').classList.remove('active');
    document.getElementById('menu-chord-trainer').classList.add('active');
  });

});

    // --- Gestion unifi√©e des dropdowns (intervals + chords) ---

    // Ouvre/ferme le dropdown au clic sur le bouton
    document.querySelectorAll('.dropdown-toggle').forEach(button => {
      button.addEventListener('click', function (e) {
        e.stopPropagation();
        const dropdown = this.closest('.dropdown');

        // Ferme les autres menus ouverts
        document.querySelectorAll('.dropdown.show').forEach(d => {
          if (d !== dropdown) d.classList.remove('show');
        });

        // Bascule l‚Äô√©tat du menu courant
        dropdown.classList.toggle('show');
      });
    });

    // ‚úÖ Emp√™che la fermeture quand on clique √† l‚Äôint√©rieur du menu
    document.querySelectorAll('.dropdown-content').forEach(menu => {
      menu.addEventListener('click', (e) => {
        e.stopPropagation();
      });
    });

    // üî¥ Ferme tous les menus quand on clique ailleurs
    document.addEventListener('click', () => {
      document.querySelectorAll('.dropdown.show').forEach(d => d.classList.remove('show'));
    });


  </script>
</body>
</html>
